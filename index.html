<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="imagetoolbar" content="no" />
    <title>Rezept</title>
<style>
body {
    margin: 0;
    padding: 0 5vw;
  font-style: normal;
}
input {
  font-family: 'Open Sans';
  font-weight: 500;
}
input::placeholder {
    color: silver;
}
ul {
    padding: 0; 
    margin: 0;
}
li {
    list-style-type: none;
    padding: 0; 
    margin: 0;
}
input[type="button"] {
    margin: 0 1rem 0 0;
    font-size: 1.5rem;
    border-radius: 1.1rem;
    border: none;
    font-weight: 100;
    width: 2.2rem;
    height: 2.2rem;
    padding: 0 0 0.1rem;
}
#recipe {    
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 0.5rem;
    border: none;
    margin: 1rem 0.1rem 1rem 0;
    width: calc(100vw - 4rem);
}
.value, .unit, .ingredient {
    margin: 0 0.1rem 1rem 0;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 0.5rem;
    border: none;
}
.value {
    width: 10%;
    min-width: 4rem;
    text-align: right;
    background-color: #eee;
}
.unit {
    width: 10%;
    min-width: 2.5rem;
    max-width: 4rem;
}
.ingredient {
    min-width: 10rem;
    width: 50%
}

.firstbreak, #break {
    background-color: #000;
    margin: 0 0 1rem;
    padding: 0;
}

.active {
    background: no-repeat center url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='DimGray' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z'%3E%3C/path%3E%3Cpath d='M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z'%3E%3C/path%3E%3C/svg%3E"), #F0F0F0;
}

.inactive {
    background: no-repeat center url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='silver' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z'%3E%3C/path%3E%3Cpath d='M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z'%3E%3C/path%3E%3C/svg%3E"), #F0F0F0;
}

@media (hover: hover) {
    li.entry:before {
        background: no-repeat center url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16px' height='16px' viewBox='0 0 16 16'%3E%3Cline stroke='%23B3B3B3' stroke-linecap='round' x1='1.5' y1='3.5' x2='14.5' y2='3.5'/%3E%3Cline stroke='%23B3B3B3' stroke-linecap='round' x1='1.5' y1='7.5' x2='14.5' y2='7.5'/%3E%3Cline stroke='%23B3B3B3' stroke-linecap='round' x1='1.5' y1='11.5' x2='14.5' y2='11.5'/%3E%3C/svg%3E");
        content: " ";
        display:inline-block;
        width: 16px;
        height: 16px;
        margin:0 1rem 0 0;
    }
}

@media print
{    
    input[type="button"], li.entry:before {
        display: none !important;
    }
    .value {
        background-color: #fff;
        margin-right:0.2rem;
    }
    .unit,.ingredient {
        margin-left:0;
        padding: 0;
    }
}
</style>
</head>

<body>
    <form id="mainform">
        <input type="text" name="recipe" id="recipe" placeholder="click to edit" onchange="update_url()">
        <hr class="firstbreak">
        <div class="sortable-list">
            <ul id="sortable">
            </ul>
        </div>
    </form>

</body>

<script>
    const splitchar = '_';
    var calc_active = false;

    function strip(number) {
        return Math.round(parseFloat(number) * 100) / 100;
    }

    function MycreateElement(name, value, placeholder, onchange) {
        var element = document.createElement("input");
        element.setAttribute("type", "text");
        element.setAttribute("name", name);
        element.setAttribute("class", name);
        if (value !== '') element.setAttribute("value", value);
        if (value !== '' && name == 'value') element.setAttribute("oldvalue",value);
        element.setAttribute("placeholder", placeholder);
        if (onchange == 'recalculate') element.onchange = function() { recalculate (element) }
        if (onchange == 'update_url') element.onchange = function() { update_url () }
        
        return element;
    }

    function recalculate (element) {

        if (!calc_active || element.name === "ingredient") {
            update_url();
            return;
        }
        if (typeof element.getAttribute("oldvalue") === 'undefined' || 
            element.getAttribute("oldvalue") == 0 || 
            element.getAttribute("oldvalue") == '' ||
            element.getAttribute("oldvalue") == null) {
                if (element.value != null) element.setAttribute("oldvalue", element.value);
                return;
            }
        var factor = strip(element.value / element.getAttribute("oldvalue"));
		var form = document.getElementById("mainform");
		element.setAttribute("oldvalue", element.value);

		Array.from(form.elements).forEach((input) => {
			if (input.type === "text" && input.name === "value" && input !== element) {
				var newval = strip(input.getAttribute("oldvalue") * factor);
				input.value = newval;
				input.setAttribute("oldvalue", newval);
			}
	    });
        update_url();
    }

    function update_url() {
		var form = document.getElementById("mainform");
		var url  = [];
		var urlparts = [];

		Array.from(form.elements).forEach((input) => {
			if (input.type === "text" && input.name !== "ingredient" && input.name !== "recipe")
				urlparts.push(encodeURIComponent(input.value));

			if (input.type === "text" && input.name === "ingredient") {
				urlparts.push(encodeURIComponent(input.value));
				url.push(urlparts.join(splitchar));
				urlparts = [];
			}
			if (input.type === "text" && input.name === "recipe") {
				url.push('recipe=' + encodeURIComponent(input.value));
				urlparts = [];
			}
	    });
        url.push('calc=' + calc_active);
		var url_new = url.filter(value => Object.keys(value).length !== 0)
		window.location = '?' + url_new.join('&');
    }

    function add_empty () {
        var li = document.createElement("li");
        li.setAttribute("draggable", "true");
        li.setAttribute("class", "entry");
        var value = MycreateElement('value', '', 'Menge', 'recalculate');
        li.appendChild(value);
        value.focus();
        li.appendChild(MycreateElement('unit', '', 'g', ''));
        li.appendChild(MycreateElement('ingredient', '', 'Zutat', 'update_url'));
        document.getElementById("sortable").appendChild(li);

    }

    function toggle_calc() {
        calc_active = !calc_active;
        if (calc_active) {
            document.getElementById("calc").setAttribute("class", "active");
        } else {
            document.getElementById("calc").setAttribute("class", "inactive");
        }
    }

    const   urlParams   = new URLSearchParams(window.location.search);
            entries     = urlParams.entries();

    if (urlParams.has("recipe")) {
        document.getElementById("recipe").setAttribute("value", urlParams.get("recipe"));
        document.title = urlParams.get("recipe");
    }

    if (urlParams.has("calc")) {
        calc_active = (urlParams.get("calc").toLowerCase() === 'true');
    }

    var has_edit = false;
    for (const entry of entries) {
        if (entry[0].split(splitchar)[0] == '' || entry[0].split(splitchar)[0] == 'recipe' || entry[0].split(splitchar)[0] == 'calc') continue;
        var li = document.createElement("li");
        li.setAttribute("draggable", "true");
        li.setAttribute("class", "entry");
        li.appendChild(MycreateElement('value', entry[0].split(splitchar)[0], 'Menge', 'recalculate'));        
        li.appendChild(MycreateElement('unit', entry[0].split(splitchar)[1], 'g', ''));
        li.appendChild(MycreateElement('ingredient', entry[0].split(splitchar)[2],'Zutat', 'update_url'));
        document.getElementById("sortable").appendChild(li);
        has_edit = true;
    }

    if (!has_edit) add_empty();

    var hr = document.createElement("hr");
    hr.setAttribute("id", 'break');
    document.getElementById("mainform").append(hr);
    
    var add = document.createElement("input")
    add.setAttribute("type", "button");
    add.setAttribute("value", "+");
    add.onclick = function() {
        add_empty();
    }
    document.getElementById("mainform").append(add);

    var del = document.createElement("input")
    del.setAttribute("type", "button");
    del.setAttribute("value", "âˆ’");
    del.onclick = function() {
        var count = document.getElementsByClassName("entry");
        document.getElementsByClassName("entry")[count.length - 1].remove();
        update_url();
    }
    document.getElementById("mainform").append(del);

    var calc = document.createElement("input")
    calc.setAttribute("type", "button");
    calc.setAttribute("value", " ");
    if (calc_active) {
        calc.setAttribute("class", "active");
    } else {
        calc.setAttribute("class", "inactive");
    }
    calc.setAttribute("id", "calc");
    calc.onclick = function() {
        toggle_calc();
    }
    document.getElementById("mainform").append(calc);

    if(!window.matchMedia("(pointer: coarse)").matches) {
    // inspired by https://www.geeksforgeeks.org/create-a-drag-and-drop-sortable-list-using-html-css-javascript/
        const sortableList = document.getElementById("sortable");
        let draggedItem = null;
        
        sortableList.addEventListener(
            "dragstart",
            (e) => {
                draggedItem = e.target;
                setTimeout(() => { 
                    e.target.style.display = "none"; 
                }, 0);
        });
        
        sortableList.addEventListener(
            "dragend",
            (e) => {
                setTimeout(() => {
                    e.target.style.display = "";
                    draggedItem = null;
                }, 0);
                update_url();
        });

        sortableList.addEventListener(
            "dragover",
            (e) => {
                e.preventDefault();
                const afterElement =
                    getDragAfterElement(sortableList, e.clientY);
                const currentElement =
                    document.querySelector(
                        ".dragging");
                if (afterElement == null) {
                    sortableList.appendChild(draggedItem);
                } else {
                    sortableList.insertBefore(draggedItem,afterElement);
                }
            });
        
        const getDragAfterElement = (
            container, y
        ) => {
            const draggableElements = [
                ...container.querySelectorAll(
                    "li:not(.dragging)"
                ),];
        
            return draggableElements.reduce(
                (closest, child) => {
                    const box =
                        child.getBoundingClientRect();
                    const offset =
                        y - box.top - box.height / 2;
                    if (
                        offset < 0 &&
                        offset > closest.offset) {
                        return {
                            offset: offset,
                            element: child,
                        };} 
                    else {
                        return closest;
                    }},
                {
                    offset: Number.NEGATIVE_INFINITY,
                }
            ).element;
        };
    }
</script>
</html>
